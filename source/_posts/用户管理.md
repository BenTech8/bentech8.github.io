---
title: 用户管理
date: 2025-02-25 13:04:38
tags:
categories: Linux
---

# 用户管理

## 1. 用户相关文件

### 1）用户信息文件

/etc/passwd

```
root:x:0:0:root:/root:/bin/bash
...
```

- 第一列：用户名

- 第二列：密码位

  x为密码标志位，代表用户有密码，用户密码放置在/etc/shadow文件中。

- 第三列：用户ID

  - 0：超级用户UID，如果用户UID为0，代表这个账号是管理员账号。那Linux中如何把普通用户升级为管理员呢？就是把其他用户的UID修改为0就可以了。不过不建议建立多个管理员账号。
  - 1-499：系统用户(伪用户)UID，这些UID账号是系统保留给系统用户的UID，也就是说UID是1-499范围内的用户是不能登录系统的，而是用来运行系统或服务的，其中1-99是系统保留的账号，系统自动创建。100-499是预留给用户创建系统账号的。
  - 500-65535：普通用户UID。建立的普通用户UID从500开始，最大到65535。这些用户足够使用了，但是如果不够也不用害怕，2.6.x内核以后的Linux系统用户UID已经可以支持2的32次方了。

- 第四列：组ID（GID）

  添加用户时，如果不指定用户所属的初始组，那么会建立和用户名相同的组。

- 第五列：用户说明

- 第六列：用户家目录（~）

- 第七列：登录shell（标准是/bin/bash）



### 2）影子文件

/etc/shadow

```
root:$6$jvGI3Z2PqL/TT4lT$q1lVTdba3dRsmWsEJVHzTqAHOSlb3qvM/hL7wKTQCo5148xfMiT0mnq1zQ7n7wCZu/QEdtP/57BVko4X6U4in0:18929:0:99999:7:::
```

- 第一列：用户名

- 第二列：加密密码

  我们也可以在密码前人为的加入“!”或“*”改变加密值让密码暂时失效，使这个用户无法登录，达到暂时禁止用户登录的效果。

  所有伪用户的密码都是"!!"或“*”，代表没有密码是不能登录的。当然新创建的用户如果不设定密码，它的密码项也是"!!"，代表这个用户没有密码，不能登录。

- 第三列：密码最近更改时间（day），1970年1月1日作为标准时间

  时间戳转日期

  ```
  date -d "1970-01-01 18929 days"
  2021年 10月 29日 星期五 00:00:00 CST
  ```

  日期转时间戳

  ```
  echo $(($(date --date="2021/10/29" +%s)/86400+1))
  18929
  ```

- 第四列：两次密码的修改间隔时间（和第3个字段相比）

- 第五列：密码有效期(和第3个字段相比)

- 第六列：密码修改到期前警告天数(和第5个字段相比)

- 第七列：密码过期后的宽限天数(和第5个字段相比)

- 第八列：密码失效时间

  这里同样要写时间戳，也就是用1970年1月1日进行时间换算，如果超过了失效时间，就算密码没有过期，用户也就失效无法使用了。

- 第九列：保留



### 3）组信息文件

/etc/group

```
root:x:0:
```

- 第一列：组名
- 第二列：组密码位
- 第三列：GID
- 第四列：此组中支持的其他用户，附加组是此组的用户
  - 初始组：每个用户初始组只能有一个，一般都是和用户名相同的组作为初始组。
  - 附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组。



### 4）组密码文件(不建议使用)

/etc/gshadow

```
root:*::
```

如果给用户组设定了组管理员，并给该用户组设定了组密码，组密码就保存在这个文件当中。组管理员就可以利用这个密码管理这个用户组了。



### 5）用户家目录

### 6）用户邮箱目录

这个邮箱在/var/spool/mail目录当中，例如lamp用户的邮箱就是/var/spool/mail/lamp文件

### 7）用户模板目录

/etc/skel/

用户家目录初始化时的模板目录。



## 2.用户管理命令

### 1）添加用户

a）手工删除用户

手工删除用户试验：手工删除，如果可以正常建立用户，证明用户删除干净。

```
# 创建用户，就是写入这6个文件
/etc/passwd
/etc/shadow
/etc/group
/etc/gshadow
/home/user1
/var/spool/mail/user1
```



b）useradd命令

```
useradd 选项 用户名
选项：
  -u：UID   指定UID
  -g：组名   指定初始组，不要手工指定
  -G：组名   指定附加组，把用户加入组，使用附加组
  -c：说明   添加说明
  -d：目录   手工指定家目录，目录不需要事先建立
  -s：shell  /bin/bash
  -m：创建家目录
```



c）useradd默认值

useradd添加用户时参考的默认值文件主要有两个：

- /etc/default/useradd

  ```
  # useradd defaults file
  GROUP=100
  HOME=/home
  INACTIVE=-1
  EXPIRE=
  SHELL=/bin/bash
  SKEL=/etc/skel
  CREATE_MAIL_SPOOL=yes
  ```

  - GROUP=100

    这个选项是建立用户的默认组，也就是说添加每个用户时，用户的初始组就是GID为100的这个用户组。

  - HOME=/home

    这个选项是用户的家目录的默认位置，所以所有的新建用户的家目录默认都在/home/下。

  - INACTIVE=-1

    这个选项就是密码过期后的宽限天数，也就是/etc/shadow文件的第七个字段。如果是天数，比如10代表密码过期后10天后失效；如果是0，代表密码过期后立即失效；如果是-1，则代表密码永远不会失效。这是默认值是-1，所以所有新建立的用户密码都不会失效。

  - EXPIRE=

    这个选项是密码失效时间，也就是/etc/shadow文件的第八个字段，也就是说用户到达这个日期后就会直接失效。当然这里也是使用时间戳来表示日期的。默认是空，所以所有新建用户没有失效时间。永久有效。

  - SHELL=/bin/bash

    这个选项是用户的默认shell。/bin/bash是Linux的标志shell，所以所有新建立的用户默认都具备shell赋予的权限。

  - SKEL=/etc/skel

    这个选项就是定义用户的模板目录的位置，/etc/skel/目录中的文件都会复制到新建用户的家目录当中。

  - CREATE_MAIL_SPOOL=yes

    这个选项定义是否给新建用户建立邮箱，默认是创建，也就是说所有的新建用户系统都会新建一个邮箱，放在/var/spool/mail/下，和用户名相同。

- /etc/login.defs

  ```
  MAIL_DIR        /var/spool/mail
  
  PASS_MAX_DAYS   99999
  PASS_MIN_DYAS   0
  PASS_MIN_LEN    5
  PASS_WARN_AGE   7
  
  UID_MIN         500
  UID_MAX         60000
  
  GID_MIN         500
  GID_MAX         60000
  
  CREATE_HOME     yes
  
  UMASK           077
  
  USERGROUPS_ENAB yes
  
  ENCRYPT_METHOD  SHA512
  ```

  - MAIL_DIR          /var/spool/mail

    这行指定了新建用户的默认邮箱位置。比如lamp用户的邮箱就是/var/spool/mail/lamp。

  - PASS_MAX_DAYS    99999

    这行指定的是密码的有效期，也就是/etc/shadow文件的第五个字段。代表多少天之后必须修改密码，默认值是99999

  - PASS_MIN_DAYS    0

    这行指定是两次密码的修改间隔时间，也就是/etc/shadow文件的第四个字段。代表第一次修改密码之后，几天后才能再次修改密码，默认值是0

  - PASS_MIN_LEN    5

    这行代表密码的最小长度，默认不小于5位，但是我们现在用户登录时验证已经被PAM模块取代，所以这个选项并不生效。

  - PASS_WARN_AGE    7

    这行代表密码修改到期前的警告天数。也就是/etc/shadow文件的第六个字段。代表密码到底有效期前多少天开始进行警告提醒，默认值是7天。

  - UID_MIN|UID_MAX

    这两行指定了UID的最小值和最大值之间的范围。

  - GID_MIN|GID_MAX

    这两行指定了GID的最小值和最大值之间的范围。

  - CREATE_HOME    yes

    这行指定建立用户时是否自动建立用户的家目录，默认是建立。

  - UMASK    077

    这行指定的是建立的用户家目录的默认权限，因为umask值是077，所以新建的用户家目录的权限是700。

  - USERGROUPS_ENAB    yes

    这行指定的是使用命令userdel删除用户时，是否删除用户的初始组，默认是删除。

  - ENCRYPT_METHOD    SHA512

    这行指定Linux用户的密码使用SHA512散列模式加密，这是新的密码加密模式，原先的Linux只能用DES或MD5方式加密。

    

### 2）设定密码

```
passwd [选项] 用户名
选项：
  -l:         暂时锁定用户。仅root用户可用（lock）
  -u:         解锁用户。仅root用户可用（unlock）
  --stdin:    可以将通过管道符输出的数据作为用户的密码。主要在批量添加用户时使用
```

示例：

```
# 修改当前用户的密码
passwd

# 使用字符串作为密码
echo "123" | passwd --stdin lamp

# 把密码修改日期归零(shadow第3个字段，0代表1970年1月1日)。这样用户一登录就要修改密码。
chage -d 0 lamp
```



### 3）用户信息修改

```
usermod [选项] 用户名
选项：
  -u UID:        修改用户的UID
  -d 家目录：     修改用户的家目录。家目录必须写绝对路径
  -c 用户说明:    修改用户的说明信息，就是/etc/passwd文件的第五个字段
  -g 组名：       修改用户的初始组，就是/etc/passwd文件的第四个字段
  -G 组名：       修改用户的附加组，其实就是把用户加入其他用户组
  -s shell:      修改用户的登录Shell。默认是/bin/bash
  -e 日期：       修改用户的失效日期，格式为"YYYY-MM-DD"。也就是/etc/shadow文件的第八个字段
  -L:            临时锁定用户(Lock)
  -U:            解锁用户(Unlock)
```

usermod也可以修改用户名，但不建议这么做，这样及其容易把管理员自己稿晕。建议删除旧用户，再建立新用户。

```
# 修改用户名
usermod -l 新名 旧名
```



### 4）删除用户

```
userdel [-r] 用户名
选项：
  -r:    在删除用户的同时删除用户的家目录
```



### 5）切换用户身份

su命令可以切换成不同的用户身份。

```
su [选项] 用户名
选项：
  -:          选项只使用“-”代表连带用户的环境变量一起切换
  -c 命令:    仅执行一次命令，而不切换用户身份
```

“-”不能省略，它代表切换用户身份时，用户的环境变量也要切换成新用户的环境变量。



## 3. 组管理命令

### 1）添加用户组

```
groupadd [选项] 组名
选项：
  -g GID:    指定组ID
```

示例：

```
# 添加group1组
groupadd group1
```



### 2）删除用户组

```
groupdel 组名
```

不过要注意，要删除的组不能是其他用户的初始组，也就是说这个组中没有初始用户才可以删除。如果组中有附加用户，则删除组时不受影响。



### 3）把用户添加进组或从组中删除

```
gpasswd [选项] 组名
选项：
  -a 用户名：    把用户加入组
  -d 用户名：    把用户从组中删除
```

```
# 添加test组
groupadd test

# 把test1用户加入test组
gpasswd -a test1 test

# 把用户test1从test组中删除
gpasswd -d test1 test
```



### 4）改变有效组

每个用户可以属于一个初始组（用户是这个组的初始用户），也可以属于多个附加组（用户是这个组的附加用户）。既然用户可以属于这么多用户组，那么用户在创建文件后，默认生效的组身份是哪个呢？当然是初始用户组的组身份。因为初始组是用户一旦登录就直接获得的组身份。也就是说，用户在创建文件后，文件的属组就是用户的初始组，因为用户的有效组默认是初始组。使用newgrp可以切换用户的有效组。

```
newgrp 组名
```



### 5. 组权限实验

根目录下创建个www目录，属主为teacher, 学生st1，st2可以往这个目录提交作业。

```
# 创建www目录
mkdir /www

# 创建teacher用户
useradd -m teacher

# 设置teacher用户密码
passwd teacher

# 创建st1,st2用户并设置密码
useradd -m st1
useradd -m st2

# 创建tg组
groupadd tg

# 将st1, st2加入tg组
gpasswd -a st1 tg
gpasswd -a st2 tg

# 设置www目录属主和属组
chown teacher:tg /www/

# 设置www目录权限
chmod 770 /www/
```

