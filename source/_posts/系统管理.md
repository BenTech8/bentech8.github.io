---
title: 系统管理
date: 2025-03-05 17:29:52
tags:
categories: Linux
---

## 进程管理

### 进程简介

1）什么是进程

进程是正在执行的一个程序或命令，每一个进程都是一个运行的实体，都有自己的地址空间，并占用一定的系统资源。

2）什么是程序

程序是人使用计算机语言编写的可以实现特定目标或解决特定问题的代码集合。



程序是人使用计算机语言编写的，可以实现一定功能，并且可以执行的代码集合。

进程是正在执行当中的程序。程序被执行时，执行人的权限和属性、以及程序的代码都会被加载如内存，操作系统给这个进程分配一个ID号，称为PID（进程ID）。



3）进程管理的作用

- 判断服务器健康状态

  运维工程师最主要的工作就是保证服务器安全稳定的运行。理想的状态是，在服务器出现问题，但是还没有造成服务器宕机或停止服务时，就人为干预解决了问题。进程管理最主要的工作就是判断服务器当前运行是否健康，是否需要人为干预。如果服务器的CPU占用率、内存占用率过高，就需要人为介入解决问题了。

- 查看系统中所有的进程

  我们需要查看系统中所有正在运行的进程，通过这些进程可以判断系统中运行了哪些服务，是否有非法服务运行。

- 杀死进程

  这是进程管理中最不常用的手段，当需要停止服务时，会通过正确关闭命令来停止服务（如apache服务可以通过service httpd sotp来关闭）。只有当正确终止进程的手段失效的情况下，才会考虑使用kill命令杀死进程（你不是杀手，不要什么进程都用kill来终止，否则非常容易导致服务器崩溃）。



### 进程的查看

#### ps命令

ps命令是用来静态显示系统中进程的命令。不过这个命令有些特殊，它的部分命令的选项不能加入“-”，比如“ps aux”，这是因为ps命令的部分选项需要遵守BSD操作系统的格式，所以ps命令的常用选项的组合是固定的。

```shell
# 查看系统中所有进程，使用BSD操作系统格式
[root@localhost ~]# pa aux
# 查看系统中所有进程，使用Linux标准命令格式
[root@localhost ~]# ps -le
选项：
  a:		显示一个终端的所有进程，除了会话引线
  u:		显示进程的归属用户及内存的使用情况
  x:		显示没有控制终端的进程
  -l:		长格式显示。显示更加详细的信息
  -e:		显示所有进程，和-A作用一致
```



```shell
[root@localhost ~]# ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.2  24104 15260 ?        Ss   3月04   0:10 /sbin/init splash
root           2  0.0  0.0      0     0 ?        S    3月04   0:00 [kthreadd]
```

- USER：该进程是由哪个用户产生的
- PID：进程的ID号
- %CPU：该进程占用CPU资源的百分比，占用越高，进程越耗费资源
- %MEM：该进程占用物理内存的百分比，占用越高，进程越耗费资源
- VSZ：该进程占用虚拟内存的大小，单位KB
- RSS：该进程占用实际物理内存的大小，单位KB
- TTY：该进程是在哪个终端中运行的。其中tty1-tty7代表本地控制台终端(可以通过alt+F1-F7键切换不同的终端)，tty1-tty6是本地的字符界面终端，tty7是图形终端。pts/0-255代表虚拟终端，一般是远程连接终端，第一个远程连接占用的是pts/0终端，第二个远程连接占用pts/1，依次增长。
- STAT：进程状态。常见状态有：
  - D：不可被唤醒的睡眠状态，通常用于I/O情况
  - R：该进程正在运行
  - S：该进程在睡眠状态，可被唤醒
  - T：停止状态，可能是在后后暂停或进程在除错状态
  - W：内存交互状态（从2.6内核开始无效）
  - X：死掉的进程（应该不会出现）
  - Z：僵尸进程。进程已经终止，但是部分程序还在内存当中。
  - <：高优先级（以下状态在BSD格式当中出现）
  - N：低优先级
  - L：被锁入内存
  - s：包含子进程
  - l：多线程
  - +：位于后台
- START：该进程的启动时间
- TIME：该进程占用CPU的运算时间，注意不是系统时间
- COMMAND：产生此进程的命令名

```shell
[root@localhost ~]# ps -le
F S   UID     PID    PPID  C PRI  NI ADDR SZ WCHAN  TTY          TIME CMD
4 S     0       1       0  0  80   0 -  6026 -      ?        00:00:10 systemd
1 S     0       2       0  0  80   0 -     0 -      ?        00:00:00 kthreadd
```

- F：进程标志，说明进程的权限，常见标志有：
  - 1：进程可以复制，但是不能执行
  - 4：进程使用超级用户权限
- S：进程状态。具体的状态和“ps aux”命令中STAT状态一致
- UID：进程是哪个UID用户调用运行的
- PID：进程的ID号
- PPID：代进程的ID号
- C：该进程的CPU使用率，单位是百分比
- PRI：进程的优先级，数值越小该进程优先级越高，越快被CPU执行
- NI：进程的优先级，也是数值越小越早被执行
- ADDR：该进程在内存的哪个位置
- SZ：该进程占用多大内存
- WCHAN：该进程是否运行。“-”代表正在运行
- TTY：该进程由哪个终端产生
- TIME：该进程占用CPU的运算时间，注意不是系统时间
- CMD：产生此进程的命令名



#### top命令

```shell
[root@localhost ~]# top [选项]
选项：
  -d 秒数：    指定top命令每隔几秒更新。默认是3秒。
  -b:  		  使用批处理模式输出。一般和"-n"选项合用，用于把top命令重定向到文件中 
  -n 次数:	 指定top命令执行的次数。一般和"-b"选项合用
  -p:		   指定PID。只查看某个PID的进程
  -s:          使top在安全模式运行，避免在交互模式中出现错误
  -u 用户名:    只监听某个用户的进程
在top命令的交互模式当中可以执行的命令：
  ？或h:	   显示交互模式的帮助
  P:		以CPU使用率排序，默认就是此项
  M:		以内存的使用率排序
  N:		以PID排序
  T:		按照CPU的累积运算时间排序，也就是用于TIME+项排序
  k:		按照PID号，给予某个进程一个信号，一般用于终止某个进程，信号9是强制终止的信号
  r:		按照PID号，给某个进程重设优先级（Nice）值
  q:		退出top
```

top执行结果：

```
[root@localhost ~]# top
top - 20:40:42 up 1 day, 11:10,  1 user,  load average: 0.62, 0.43, 0.45
任务: 394 total,   1 running, 385 sleeping,   8 stopped,   0 zombie
%Cpu(s):  1.9 us,  3.9 sy,  0.0 ni, 94.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st 
MiB Mem :   6865.1 total,    245.4 free,   4582.3 used,   2676.1 buff/cache     
MiB Swap:   2048.0 total,    789.7 free,   1258.3 used.   2282.8 avail Mem 
 进程号 USER      PR  NI    VIRT    RES    SHR    %CPU  %MEM     TIME+ COMMAND                                                     
 231207 ben       20   0   17672   5632   3456 R  23.1   0.1   0:00.06 top                                                       
      1 root      20   0   24104  14620   9348 S   0.0   0.2   0:11.09 systemd                                                   
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.06 kthreadd                                                   
      3 root      20   0       0      0      0 S   0.0   0.0   0:00.00 pool_workqueue_release        
```

top命令的输出内容是动态的，默认每3秒刷新一次。命令的输出主要分为两大部分；第一部分是前五行，显示的是整个系统的资源使用状况，我们就是通过这些输出判断服务器的健康状态；第二部分从第六行开始，显示的是系统中进程的信息。

- 第一部分内容

  - 第一行信息为任务队列信息

    | 内容                           | 说明                                                         |
    | ------------------------------ | ------------------------------------------------------------ |
    | 20:40:42                       | 系统当前时间                                                 |
    | up 1 day, 11:10                | 系统的运行时间，本机已经运行1天11小时10分钟                  |
    | 1 user                         | 当前登录了1个用户                                            |
    | load average: 0.62, 0.43, 0.45 | 系统在之前1分钟，5分钟，15分钟的平均负载。如果CPU是单核，则这个数超过1，就是高负载。如果CPU是四核，则这个数超过4，就是高负载。（这个平均负载完全是个人经验来进行判断的，一般认为不应该超过服务器CPU的核数。） |

  - 第二行为进程信息

    | 内容            | 说明                                      |
    | --------------- | ----------------------------------------- |
    | 任务: 394 total | 系统中的进程总数                          |
    | 1 running       | 正在运行的进程数                          |
    | 385 sleeping    | 睡眠的进程                                |
    | 8 stopped       | 正在停止的进程                            |
    | 0 zombie        | 僵尸进程。如果不是0，需要手工检查僵尸进程 |

  - 第三行为CPU信息

    | 内容             | 说明                                                         |
    | ---------------- | ------------------------------------------------------------ |
    | %Cpu(s):  1.9 us | 用户模式占用的CPU百分比                                      |
    | 3.9 sy           | 系统模式占用的CPU百分比                                      |
    | 0.0 ni           | 改变过优先级的用户进程占用的CPU百分比                        |
    | 94.2 id          | 空闲CPU的CPU百分比                                           |
    | 0.0 wa           | 等待输入/输出的进程的占用CPU百分比                           |
    | 0.0 hi           | 硬中断请求服务占用的CPU百分比                                |
    | 0.0 si           | 软中断请求服务占用的CPU百分比                                |
    | 0.0 st           | st（Steal time）虚拟时间百分比。就是当有虚拟机时，虚拟CPU等待实际CPU的时间百分比 |

  - 第四行为物理内存信息

    | 内容                 | 说明                    |
    | -------------------- | ----------------------- |
    | Mem :   6865.1 total | 物理内存的总量          |
    | 245.4 free           | 空闲的物理内存数量      |
    | 4582.3 used          | 已经使用的物理内存数量  |
    | 2676.1 buff/cache    | 作为缓冲/缓存的内存数量 |

  - 第五行为交换分区（swap）信息

    | 内容                 | 说明                         |
    | -------------------- | ---------------------------- |
    | Swap:   2048.0 total | 交换分区（虚拟分区）的总大小 |
    | 789.7 free           | 空闲交换分区的大小           |
    | 1258.3 used          | 已经使用的交互分区的大小     |
    | 2282.8 avail Mem     | 可利用的交互分区的大小       |



- 第二部分内容

  主要是系统进程信息。这部分和ps命令的输出比较类似，只是如果在终端中执行top命令不能看到所有的进程，而只能看到占比靠前的进程。

  - PID: 进程ID
  - USER: 该进程所属的用户
  - PR: 优先级，数值越小优先级越高
  - NI: 优先级，数值越小优先级越高
  - VIRT: 该进程使用的虚拟内存的大小，单位KB
  - RES: 该进程使用的物理内存的大小，单位KB
  - SHR: 共享内存大小，单位KB
  - %CPU: 该进程占用CPU的百分比
  - %MEM: 该进程占用内存的百分比
  - TIME+: 该进程总共占用的CPU时间
  - COMMAND: 进程的命令名



top命令查看某一个进程:

```shell
# 只查看PID为15273的apache进程
[root@localhost ~]# top -p 15273
```

在top命令的交互界面中按“q”键会退出top命令。也可以按“?”或“h”得到top命令交互界面的帮助信息。也可以按“k”键终止某个进程。

```shell
[root@localhost ~]# top
top - 21:30:33 up 1 day, 12:00,  1 user,  load average: 2.53, 1.43, 1.12
任务: 391 total,   1 running, 382 sleeping,   8 stopped,   0 zombie
%Cpu(s):  5.5 us,  3.1 sy,  0.0 ni, 91.2 id,  0.2 wa,  0.0 hi,  0.1 si,  0.0 st 
MiB Mem :   6865.1 total,    196.3 free,   4604.8 used,   2714.5 buff/cache     
MiB Swap:   2048.0 total,    742.7 free,   1305.3 used.   2260.2 avail Mem 
PID to signal/kill [default pid = 166294]                               # 按"k"键，会提示输入要杀死进程的PID
```

如果在操作终端执行top命令，并不能看到系统中所有的进程，默认看到的只是CPU占比靠前的进程。如果我们想要看到所有的进程可以把top命令的结果重定向到文件当中即可：

```shell
# 让top命令只执行一次，然后把结果保存到top.log文件中。这样就能看到所有的进程了
[root@localhost ~]# top -b -n 1 > /root/top.log
```

