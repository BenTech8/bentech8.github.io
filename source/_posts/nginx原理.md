---
title: nginx原理
date: 2025-03-12 06:03:50
tags:
categories: Nginx
---

## Nginx概述

Nginx是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔、赛索耶夫为俄罗斯访问第二的Rambler.ru站点开发的，第一个公开版本0.1.0发布于2004年10月4日。

Nginx是一款轻量级的Web服务器/反向代理服务器及电子邮件(IMAP/POP3)代理服务器，在BSD-like协议下发行。其特点是占有内存少，并发能力强。



## Nginx工作原理

### 同步与异步

同步与异步的重点在消息通知的方式上，也就是调用结果的通知方式不同。

同步：当一个同步调用发出去后，调用者要一直等待调用的结果通知后，才能进行后续的执行。

异步：当一个异步调用发出去后，调用者不必一直等待调用结果的返回，异步调用要想获得结果，一般有两种方式：

- 主动轮询异步调用的结果；
- 被调用方通过callback(回调通知)来通知调用方调用结果。



实例解释：

同步取快递：小明收到快递将送达的短信，在楼下一直等到快递送达。

异步取快递：小时收到快递将送达的短信，快递到楼下后，小明再下楼去取。

异步取快递，小明知道快递到达楼下有两种方式：

- 不停的电话问快递小哥到了没有，即主动轮询；
- 快递小哥到楼下后，打电话通知小明，然后小明下楼取快递，既定回调通知。



### 阻塞与非阻塞

阻塞与非阻塞的重点在于进/线程等待消息时候的行为，也就是在等待消息的时候，当前进/线程是挂起状态，还是非挂起状态。

阻塞：调用在发出去后，在消息返回之前，当前进/线程会被挂起，直到有消息返回，当前进/线程才会被激活。

非阻塞：调用在发出去后，不会阻塞当前进/线程，而会立即返回。



同步与异步，重点在于消息通知的方式；阻塞与非阻塞，重点在于等消息时候的行为。所以，就出现了四种重合方式：

- 同步阻塞

  小明收到信息后，啥都不干，等快递。

- 同步非阻塞

  小明收到信息后，边刷微博，边等着取快递。

- 异步阻塞

  小明收到信息后，啥都不干，一直等着快递员通知他取快递。

- 异步非阻塞

  小明收到信息后，边刷着微博，边等快递员通知他取快递。



大部分程序的I/O模型都是同步阻塞的，单个进程每次只在一个文件描述符上执行I/O操作，每次I/O系统调用都会阻塞，直到完成数据传输，传统的服务器采用的就是同步阻塞的多进程模型。一个server采用一个进程负责一个request的方式，一个进程负责一个request，直到会话结束。进程数就是并发数，而操作系统支持的进程数是有限的，且进程数越多，调度的开销也越大，因此无法面对高并发。



### epoll模型

Nginx采用了异步非阻塞的方式工作。先了解一下I/O多路复用中的epoll模型：

当连接有I/O事件产生的时候，epoll就会去告诉进程哪个连接有I/O事件产生，然后进程就去处理这个事件。

例如：小明家楼下有一个收发室，每次有快递到了，门卫就先代收并做了标记；然后通知小明去取送给小明的快递。



### Nginx工作原理

Nginx配置use epoll后，以异步非阻塞方式工作，能够轻松处理百万级的并发连接。

处理过程：

每进来一个request，会有一个worker进程去处理。但不是全程的处理，处理到可能发生阻塞的地方。比如向后端服务器转发request，并等待请求返回。那么，这个处理的worker不会这么傻等着，他会在发送完请求后，注册一个事件：“如果后端服务器返回了，告诉我一声，我再接着干”。于是他就休息去了。此时如果再有新的request进来，他就可以很快再按这种方式处理。而一旦后端服务器返回了，就会触发这个事件，worker才会来接手，这个request才会接着往下走。通过这种快速处理，快速释放请求的方式，达到同样的配置可以处理更大并发量的目的。



## Nginx工作模式

### master-worker模式

该模式下，nginx启动成功后，会有一个master进程和至少一个worker进程。master进程负责处理系统信号，加载配置，管理worker进程(启动，杀死，监控，发送消息/信号等)。worker进程负责处理具体的业务逻辑，也就是说，对外部来说，真正提供服务的是worker进程。生产环境下一般使用这种模式，这个模式有以下优点：

- 稳定性高，只要还有worker进程存活，就能够提供服务，并且一个worker进程挂掉master进程会立即启动一个新的worker进程，保证worker进程数量不变，降低服务中断的概率。
- 配合linux的cpu亲和性配置，可以充分利用多核cpu的优势，提升性能。
- 处理信号/配置重新加载/升级时可以做到尽可能少或者不中断服务(热重启)。



### 单进程模式

单进程模式下，nginx启动后只有一个进程，nginx的所有工作都由这个进程负责。由于只有一个进程，因此可以很方便地利用gdb等工具进行调试。该模式下不支持nginx的平滑升级功能，任何的信号处理都可能造成服务中断，并且由于是单进程，进程挂掉后，在没有外部监控的情况下，无法重启服务。因此，该模式一般只在开发阶段和调试时使用，生产环境下不会使用。
