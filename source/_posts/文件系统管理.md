---
title: 文件系统管理
date: 2025-02-25 13:05:05
tags:
categories: Linux
---

# 文件系统管理

## 1. 硬盘结构

### 1）硬盘的逻辑结构

每个扇区的大小是固定的，为512Byte。扇区也是磁盘的最小存储单位。

硬盘的大小是用"磁头数X柱面数X扇区数X每个扇区的大小"这样的公式来计算的。其中磁头数(Heads)表示硬盘总共有几个磁头，也可以理解成硬盘有几个盘面，然后乘以2；柱面数(Cylinders)表示硬盘每一面盘片有几条磁道；扇区数(Sectors)表示每条磁道上有几个扇区；每个扇区的大小一般是512Byte。

### 2）硬盘接口

- IDE硬盘接口(Integrated Drive Electronics，并口，即电子集成驱动器)

  也称作"ATA硬盘"或"PATA硬盘"，是早期机械硬盘的主要接口，ATA133硬盘的理论速度可以达到133MB/s(此速度为理论平均值)。

- SATA接口(Serial ATA，串口)

  是速度更高的硬盘标准，具备了更高的传输速度，并具备了更强的纠错能力。目前已经是SATA三代，理论传输速度达到600MB/s(此速度为理论平均值)。

- SCSI接口(Small Computer System Interface，小型计算机系统接口)广泛用在服务器上，具有应用范围广、多任务、带宽大、CPU占用率低及支持执插拔等优点，理论传输速度达到320MB/s。



## 2. 文件系统

### 1）Linux文件系统的特性

- super block（超级块）

  记录整个文件系统的信息，包括：

  - block与inode的总量
  - 已经使用的inode和block的数量
  - 未使用的inode和block的数量
  - block与inode的大小
  - 文件系统的挂载时间
  - 最近一次的写入时间
  - 最近一次的磁盘检验时间等

- data block（数据块，也称作block）

  用来实际保存数据的，block的大小(1KB|2KB|4KB)和数量在格式化后就已经决定，不能改变，除非重新格式化。每个block只能保存一个文件的数据，要是文件数据小于一个block块，那么这个block的剩余空间不能被其他文件使用；要是文件数据大于一个block块，则占用多个block块。Windows中磁盘碎片整理工具的原理就是把一个文件占用的多个block块尽量整理到一起，这样可以加快读写速度。

- inode（i节点）

  用来记录文件的权限(r、w、x)，文件的所有者和属组，文件的大小，文件的状态改变时间(ctime)，文件的最近一次读取时间(atime)，文件的最近一次修改时间(mtime)，文件的数据真正保存的block编号。每个文件需要占一个inode。



### 2）Linux常见文件系统

| 文件系统 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| ext      | Linux中最早的文件系统，由于在性能和兼容性上具有很多缺陷，现在已经很少使用。 |
| ext2     | 是ext文件系统的升级版本，Red Hat Linux 7.2版本以前的系统默认都是ext2文件系统。于1993年发布，支持最大16TB的分区和最大2TB的文件 |
| ext3     | 是ext2文件系统的升级版本，最大的区别就是带日志功能，以便在系统突然停止时提高文件系统的可靠性。支持最大16TB的分区和最大2TB的文件 |
| ext4     | 是ext3文件系统的升级版。ext4在性能、伸缩性和可靠性方面进行了大量改进。ext4的变化可以说是翻天覆地的，比如向下兼容ext3、最大1EB文件系统和16TB文件、无限数量子目录、Extents连续数据块概念、多块分配、延迟分配、持久分配、快速FSCK、日志校验、无日志模式、在线碎片整理、inode增强、默认启用barrier等。它是CentOS 6.x的默认文件系统 |
| xfs      | XFS最早针对IRIX操作系统开发，是一个高性能的日志型文件系统，能够在断电以及操作系统崩溃的情况下保证文件系统数据的一致性。它是一个64位的文件系统，后来进行开源并且移植到了Linux操作系统中，目前CentOS 7.x将XFS+LVM作为默认的文件系统，据官方所称，XFS对于大文件的读写性能较好。 |
| swap     | swap是Linux中用于交换分区的文件系统(类似于Windows中的虚拟内存)，当内存不够用时，使用交换分区暂时替代内存。一般大小为内存的2倍，但不要超2GB。它是Linux的必需分区。 |
| NFS      | NFS是网络文件系统(Network File System)的缩写，是用来实现不同主机之间文件共享的一种网络服务，本地主机可以通过挂载的方式使用远程共享的资源 |
| ISO9660  | 光盘的标准文件系统，Linux要想使用光盘，必须支持iso9660文件系统 |
| fat      | 就是Windows下的fat16文件系统，在Linux中识别为fat             |
| vfat     | 就是Windows下的fat32文件系统，在Linux中识别为vfat。支持最大32GB的分区和最大4GB的文件。 |
| NTFS     | 就是Windows下的NTFS文件系统，不过Linux默认是不能识别NTFS文件系统的，如果需要识别，则需要重新编译内核才能支持。它比fat32文件系统更加安全，速度更快，支持最大2TB的分区和最大64GB的文件。 |



## 3. 常用的硬盘管理命令

### 1）df命令

```
[root@localhost ~]# df -ahT
选项：
  -a:    显示特殊文件系统，这些文件系统几乎都是保存在内存中的。如/proc,因为挂载在内存中，所以占用量都是0
  -h:    单位不是只用KB，而是换算成习惯单位
  -T:    多出了文件系统类型一列
```



### 2）du命令

```
[root@localhost ~]# du [选项] [目录或文件名]
选项：
  -a 显示每个子文件的磁盘占用量。默认只统计子目录的磁盘占用量
  -h 使用习惯单位显示磁盘占用量，如KB，MB或GB等
  -s 统计总占用量，而不列出子目录和子文件的占用量
```

du与df的区别：du是用于统计文件大小的，统计的文件大小是准确的；df是用于统计空间大小的，统计的剩余空间是准确的。

```
[root@localhost ~]# df -Th
文件系统        类型      大小  已用  可用 已用% 挂载点
tmpfs           tmpfs     687M  2.5M  685M    1% /run
/dev/nvme0n1p10 ext4      187G  144G   34G   82% /
tmpfs           tmpfs     3.4G  5.4M  3.4G    1% /dev/shm
tmpfs           tmpfs     5.0M   12K  5.0M    1% /run/lock
efivarfs        efivarfs  148K  112K   32K   79% /sys/firmware/efi/efivars
/dev/nvme0n1p1  vfat       96M   53M   44M   56% /boot/efi
tmpfs           tmpfs     687M  172K  687M    1% /run/user/1000

[root@localhost ~]# du -sh /
113G	/
```

df和du统计的根目录大小有差异，是因为du统计的是根目录文件大小，df统计的不仅只有根目录文件大小，还有临时文件的大小。



### 3）fsck文件系统修复命令

```shell
[root@localhost ~]# fsck -y 分区                  # 开机重启自动修复
```



### 4）显示磁盘状态

```shell
[root@localhost ~]# dumpe2fs -h 分区
```



### 5）查看文件的详细时间

```shell
[root@localhost ~]# stat 文件名
```



### 6）判断文件类型

```shell
[root@localhost ~]# file 文件名
```



### 7）判断命令类型

```shell
[root@localhost ~]# type 命令名
```



## 4. fdisk命令手工分区

### 1）查看系统所有硬盘及分区

```
[root@localhost ~]# fdisk -l
```



### 2）磁盘分区

```
[root@localhost ~]# fdisk 磁盘
```

fdisk交互指令说明：

| 命令 | 说明                                                      |
| ---- | --------------------------------------------------------- |
| a    | 设置可引导标记                                            |
| b    | 编辑bsd磁盘标签                                           |
| c    | 设置DOS操作系统兼容标记                                   |
| d    | 删除一个分区                                              |
| l    | 显示已知的文件系统类型。82为Linux swap分区，83为Linux分区 |
| m    | 显示帮助菜单                                              |
| n    | 新建分区                                                  |
| o    | 建立空白DOS分区表                                         |
| p    | 显示分区列表                                              |
| q    | 不保存退出                                                |
| s    | 新建空白SUN磁盘标签                                       |
| t    | 改变一个分区的系统ID                                      |
| u    | 改变显示记录单位                                          |
| v    | 验证分区表                                                |
| w    | 保存退出                                                  |
| x    | 附加功能                                                  |

新建主分区：n---p---1---1分区号---分区大小+100M---w

新建扩展分区：n---e---2分区号---124起始柱面---1024柱面(所有剩余空间都分配给扩展分区)

新建逻辑分区：n---l---不用指定分区号---124起始柱面---+100M(指定大小)---w



### 3）格式化

a）mkfs

mkfs命令非常简单易用，不过是不能调整分区的默认参数的（比如块大小是4096），这些默认参数除非特殊情况，否则不能调整。

```
[root@localhost ~]# mkfs -t 文件系统类型 分区
```



b）mke2fs

```
[root@localhost ~]# mke2fs [选项] 分区
[选项]：
  -t 文件系统：    指定格式化成哪个文件系统，如ext4, xfs
  -b 字节:        指定block块的大小
  -i 字切:        指定"字节/inode"的比例，也就是多少个字节分配一个inode
  -j：            建立带有ext3日志功能的文件系统
  -L 卷标名:      给文件系统设置卷标名，就不使用e2label命令设定了
```



### 4）建立挂载点

```
[root@localhost ~]# mkdir /disk1
```



### 5）挂载

```
[root@localhost ~]# mount 分区 挂载点
```



### 6）查看

```
# 查看所有已经挂载的分区和光盘
[root@localhost ~]# mount

# 查看系统分区
[root@localhost ~]# fdisk -l

# 查看分区占用百分比
[root@Loaclhost ~]# df -Th
```



### 7）自动挂载

修改分区自动挂载文件(/etc/fstab)。此文件直接参与系统启动，如果修改错误，系统启动报错。

```
[root@localhost ~]# vim /etc/fstab
...
/dev/sdb1              /disk1               ext4            defaults            1                  2
```

- 第一列：设备文件名
- 第二列：挂载点
- 第三列：文件系统
- 第四列：挂载选项
- 第五列：是否可以被备份。0（不备份） 1（每天备份） 2（不定期备份）
- 第六列：是否检测磁盘。0（不检测） 1（启动时检测） 2（启动后检测）

也可以使用UUID进行挂载，UUID（硬盘通用唯一识别码，可以理解为硬盘的ID）。

- 这个字段在CentOS 5.5的系统当中是写入分区的卷标名或分区设备文件名的，现在变更成硬盘的UUID。这样做的好处是当硬盘增加了新的分区，或者分区的顺序改变，再或者内核升级后，仍然能够保证分区能够正确的加载，而不至于造成启动障碍。
- dumpe2fs命令可以查看磁盘状态

```
[root@localhost ~]# dumpe2fs /dev/sdb5
```

或者：

```
[root@localhost ~]# ls -l /dev/disk/by-uuid/
```



### 8）重启测试

或者使用"mount -a"重新挂载所有内容，用它进行测试。



## 5. /etc/fstab文件修复

- 服务器连接显示器输入root密码登录系统。

- 此时根目录为只读文件系统，需要重新挂载

  ```
  [root@localhost ~]# mount -o remount,rw /
  ```

- 修改/etc/fstab文件内容至正确。

- 重启服务器

  ```
  [root@localhost ~]# reboot
  ```

  

## 6 parted命令分区

Linux系统中有两种常见的分区表：

- MBR分区表（主引导记录分区表）

  支持的最大分区是2TB，最多支持4个主分区，或3个主分区1个扩展分区。

- GPT分区表（GUID分区表）

  支持最大18EB分区，最多支持128个分区，其中1个系统保留分区，127个用户自定义分区。

不过parted命令也有点小问题，就是命令自身分区的时候只能格式化成ext2文件系统，不支持ext3和ext4文件系统。不过这没有太多的影响，因为我们可以先分区再用mkfs进行格式化。

```
[root@localhost ~]# parted 硬盘
```

| parted交互命令                          | 说明                                     |
| --------------------------------------- | ---------------------------------------- |
| check NUMBER                            | 做一次简单的文件系统检测                 |
| cp [FROM-DEVICE] FROM-NUMBER TO NUMBER  | 复制文件系统到另一个分区                 |
| help [COMMAND]                          | 显示所有的命令帮助                       |
| mklabel,mktable LABEL-TYPE              | 创建新的磁盘卷标(分区表)                 |
| mkfs NUMBER FS-TYPE                     | 在分区上建立文件系统                     |
| mkpart PART-TYPE [FS-TYPE] START END    | 创建一个分区                             |
| mkpartfs PART-TYPE FS-TYPE START END    | 创建分区，并建立文件系统                 |
| move NUMBER START END                   | 移动分区                                 |
| name NUMBER NAME                        | 给分区命名                               |
| print [devices\|free\|list,all\|NUMBER] | 显示分区表，活动设备，空闲空间，所有分区 |
| quit                                    | 退出                                     |
| rescue START END                        | 修复丢失的分区                           |
| resize NUMBER START END                 | 修改分区大小                             |
| rm NUMBER                               | 删除分区                                 |
| select DEVICE                           | 选择需要编辑的设备                       |
| set NUMBER FLAG STATE                   | 改变分区标记                             |
| toggle [NUMBER [FLAG]]                  | 切换分区表的状态                         |
| unit UNIT                               | 设置默认的单位                           |
| Version                                 | 显示版本                                 |



### 1）查看分区

```
[root@localhost ~]# parted /dev/sdb
(parted) print                                 # 输入print指令
Model： VMware, VMware Virtual S（scsi）        # 硬盘参数
Disk /dev/sdb：21.5GB                           # 硬盘大小
Sector size (logical/physical)：512B/512B       # 扇区大小
Partition Table：msdos                          # 分区表类型，就是MBR分区表
Number      Start    End     Size    Type    File system    标志
1           32.3kB   5379MB  5379MB   primary
```

### 2）修改成GPT分区表

```
[root@localhost ~]# parted /dev/sdb
（parted）mklabel gpt
警告：正在使用/dev/sdb上的分区                            # 由于/dev/sdb分区已经挂载，所以有警告

忽略/Ingore/放弃/Cancel? ignore                         # 输入ignore忽略报错
警告：The existing disk label on /dev/sdb will be destroyed and all data on this disk will be lost, Do you want to continue?
是/Yes/否/No? yes                                       # 输入yes
警告：WARNING：the kernel failed to re-read the partition table on /dev/sdb（设备或资源忙）. As a result,it may not reflect all of your changes until after reboot.                        # 下次重启后，才能生效

（parted）print                                          # 查看分区表
Model：VMware, VMware Virtual S （scsi）
Disk /dev/sdb：21.5GB
Sector size （logical/physical）：512B/512B
Partition Table: gpt                                     # 分区表已经变成GPT

Number    Start    End    Size    File system    Name    标志          # 所有的分区都消失了
```

修改了分区表，如果这块硬盘已经有分区了，那么原有分区和分区中的数据都会消失，而且需要重启系统才会生效。

转换分区表的目的是为了支持大于2TB的分区，如果分区并没有大于2TB，那么这步是可以不执行的。

**注意：**一定要把/etc/fstab文件中和原有分区的内容删除掉，才能重启，不然系统重启一定会报错。



### 3）建立分区

因为修改过分区表，所以/dev/sdb中的所有数据丢失了。

```
[root@localhost ~]# parted /dev/sdb
（parted）mkpart                                    # 输入创建分区命令
分区名称?  []? disk1                                 # 分区名称
文件系统类型？  [ext2]?                               # 文件系统类型，直接回车，使用默认ext2
起始点? 1MB                                          # 分区从1MB开始
结束点? 5GB                                          # 分区到5GB结束
(parted) print                                      # 查看分区
Model：VMware, VMware Virtual S （scsi）
Disk /dev/sdb：21.5GB
Sector size （logical/physical）：512B/512B
Partition Table: gpt

Number    Start    End    Size    File system    Name    标志
1         1049kB   5000MB  4999MB                disk1
```



### 4）建立文件系统

分区分完了，还需要格式化。不过如果使用parted交互命令格式化的话，只能格式化成ext2文件系统。

```
（parted）mkfs
WARNING：you are attempting to use parted to operate on （mkfs） a file system. parted's file system manipulation code is not as rebust as what you'll find in dedicated, file-system-specific packages like e2fsprogs. We recommand you use parted only to manipulate partition tables, whenever possible. Support for performing most operations on most types of file systems will be removed in an upcoming release.
警告：The existing file system will be destoryed and all data on the partition will be lost.
Do you want to continue?
是/Yes/否/No? yes                                # 警告你格式化数据会丢失
分区编号? 1
文件系统类型?  [ext2]?                             # 指定文件系统类型
(parted) print                                      # 查看分区
Model：VMware, VMware Virtual S （scsi）
Disk /dev/sdb：21.5GB
Sector size （logical/physical）：512B/512B
Partition Table: gpt

Number    Start    End    Size    File system    Name    标志
1         1049kB   5000MB  4999MB    ext2        disk1
```

如果要格式化成ext4文件系统，需要使用Linux的mkfs命令。



### 5）删除分区

```
(parted) rm                                     # 删除分区命令
分区编号? 1                                      # 指定分区号
(parted) print                                      # 查看分区
Model：VMware, VMware Virtual S （scsi）
Disk /dev/sdb：21.5GB
Sector size （logical/physical）：512B/512B
Partition Table: gpt

Number    Start    End    Size    File system    Name    标志
```

parted中的所有操作都是立即生效，没有保存生效的概念，这点和fdisk交互命令明显不同。

至于到底使用fdisk还是parted进行分区？推荐分区大小小于2GB，使用fdisk分区；分区大小大于2GB，使用parted分区。 



## 7. swap分区

### 1）分区

```
[root@localhost ~]# fdisk /dev/sdb
Command (m for help): t                               # 修改分区的系统id
Selected partition 1                                  # 选择分区
Hex code (type L to list codes)：82                    # 改为swap的id
Changed system type of partition 1 to 82 (Linux swap / Solaris)
```



### 2）格式化

```
[root@localhost ~]# mkswap /dev/sdb1
Setting up swapspace version 1, size = 522076 KiB
no label, UUID=C3351dc3-f403-419a-9666-c24615e170fb
```



### 3）挂载

swap空间支持扩容。扩容也使用swapon命令

```
[root@localhost ~]# swapon /dev/sdb1
```

开机自动挂载：

```
[root@localhost ~]# vim /etc/fstab
...
/dev/sdb1      swap      swap      defaults      0      0
```

也可以使用uuid。
