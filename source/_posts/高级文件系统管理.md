---
title: 高级文件系统管理
date: 2025-02-25 13:05:22
tags:
categories: Linux
---

# 高级文件系统管理

## 1. 磁盘配额

### 1）磁盘配额条件

- 内核必须支持磁盘配额

  ```
  [root@localhost ~]# grep CONFIG_QUOTA /boot/config-2.6.32-279.el6.i686
  CONFIG_QUOTA=y
  CONFIG_QUOTA_NETLINK_INTERFACE=y
  # CONFIG_QUOTA_DEBUG is not set
  CONFIG_QUOTA_TREE=m
  CONFIG_QUOTACTL=y
  ```

- 系统中必须安装了quota工具，Linux默认是安装了quota工具

  ```
  [root@localhost ~]# rpm -qa | grep quota
  quota-3.17-16.el6.i686
  ```

  要支持磁盘配额的分区必须开启磁盘配额功能，这个功能需要手工开启，不再是默认就开启的。



### 2）概念

- 用户配额和组配额
- 磁盘容量限制和文件个数限制
- 软限制和硬限制
- 宽限时间

如果用户的空间占用数处于软限制和硬限制之间，都会在用户登录时警告用户磁盘将满，这个时间就是宽限时间，默认是7天。如果达到了宽限时间，用户的磁盘占用量还超过软限制，那么软限制就会升级为硬限制。



### 3）磁盘配额规划

磁盘配额实验：

- 磁盘配额是限制普通用户在分区上使用磁盘空间和文件个数的，所以我们需要指定一个分区，那么我们手工建立一个5GB的/dev/sdb1分区，把它挂载到/disk目录当中。
- 还有我们需要建立被限制的用户和用户组。那么我们假设需要限制user1、user2和user3用户，这三个用户属于test组。
- 其中test组磁盘容量硬限制为500MB，软限制450MB，文件个数不做限制。user1用户为了便于测试，磁盘容量硬限制为50MB，软限制为40MB，文件个数硬限制为10个，软限制为8个。user2和user3用户磁盘容量硬限制为250MB，软限制为200MB，文件个数不做限制。
- user1、user2和user3用户加起来的磁盘容量限制为550MB，超过了test组的磁盘容量500MB。这样的话，某个用户可能达不到自己的用户限制，而达到组限制时就不能再写入数据了。也就是说，如果用户限制和组限制同时存在，那么哪个限制更小，哪个限制优先生效。
- 系统宽限时间改为8天。

磁盘配额步骤：

- 分配5GB的/dev/sdb1分区，并将它挂载到/disk目录当中。

- 建立需要做限制的用户和用户组

  ```
  [root@localhost ~]# groupadd test
  [root@localhost ~]# useradd -G test user1
  [root@localhost ~]# useradd -G test user2
  [root@localhost ~]# useradd -G test user3
  [root@localhost ~]# passwd user1
  [root@localhost ~]# passwd user2
  [root@localhost ~]# passwd user3
  ```

- 在分区上开启磁盘配额功能

  ```
  [root@localhost ~]# mount -o remount,usruota,grpquota /disk    # 重新挂载/disk分区，并加入用户和用户组的磁盘配额功能
  ```

  要想永久生效，则需要修改/etc/fstab文件：

  ```
  [root@localhost ~]# vim /etc/fstab
  ...
  /dev/sdb1    /disk    ext4    defaults,usrquota,grpquota    0    0
  ...
  
  [root@localhost ~]# mount -o remount /disk    # 修改配置文件如果想要生效，必须重启系统，否则也需要把分区重新挂载一遍
  ```

- 建立磁盘配额的配置文件

  ```
  [root@localhost ~]# quotacheck [选项] [分区名]
  选项：
    -a：扫描/etc/mtab文件中所有启用磁盘配额功能的分区。如果加入此参数，命令后面就不需要加入分区名了
    -c：不管原有的配置文件，重新扫描并建立新的配置文件
    -u：建立用户配额的配置文件，也就是生成aquota.user文件
    -g：建立组配额的配置文件，会生成aquota.group文件
    -v：显示扫描过程
    -m：强制以读写的方式扫描文件系统，和-M类似。一般扫描根分区时使用。
    -f：强制扫描文件系统，并写入新的配置文件。一般扫描新添加的硬盘分区时使用。
  ```

  ```
  [root@localhost ~]# quotacheck -avug
  ```

  需要关闭SELinux，否则会报错。

  ```
  [root@localhost ~]# ll /disk/
  总计 24
  -rw-------   1 root root  6144  4月 31 19:30 aquota.group
  -rw-------   1 root root  6144  4月 18 19:30 aquota.user
  # /disk目录中两个配额配置文件已经建立
  ```

  如果需要给根分区开启配额功能，需要：

```
[root@localhost ~]# vim /etc/fstab
...
UUID=c2ca6f57-b15c-43ea-bca0-f239083d8bd2    /    ext4    defaults,usrquota,grpquota    1    1
...

[root@localhost ~]# mount -o remount /
[root@localhost ~]# quotacheck -avugm
```

如果我们自动扫描/分区建立配额文件时，因为/分区已经挂载成读写系统，而quotacheck需要把分区先挂载成只读分区，然后建立配置文件，最后再挂载回来，所以不能直接在/分区建立配置文件，这时就需要使用-m强制以读写方式扫描文件系统了。

- 设置用户和组的配额限制

  ```  
  [root@localhost ~]# edquota [选项] [用户名或组名]
  选项：
    -u 用户名：  设定用户配额
    -g 组名：    设定组配额
    -t：        设定宽限时间
    -p：        复制配额限制。如果已经设定好某个用户的配额限制，其他用户的配额限制如果和这个用户相同，那么可以直接复制配额限制，而不用都手工指定
  ```

  ```
  [root@localhost ~]# edquota -u user1
  # edquota命令进入之后，就是标准的vi操作方法
  Disk quotas for user user1（uid 500）：
  # 磁盘配额是设定用户user1（UID是500）
  Filesystem    blocks        soft     hard     inodes        soft      hard
  /dev/sdb1       0           40000    50000      0            8         10
  # 分区名        已占用容量    软限制    硬限制     已占用文件数   软限制     硬限制
  ```

- 配额复制

  user3用户的配额值和user2用户完全一样，就可以使用user2用户作为模板进行复制，这样我们如果需要建立大量的配额值一致的用户时，就会非常方便，不用一个个手工建立了：

  ```
  [root@localhost ~]# edquota -p user2 -u user3
  ```

- 修改宽限时间

  ```
  [root@localhost ~]# edquota -t
  Grace period before enforcing soft limits for users:
  Time units may be: days, hours, minutes, or seconds
  Filesystem    Block grace period    Inode grace period
  /dev/sdb1       8days                8days
  # 分区名        容量的宽限时间          个数的宽限时间
  ```

  

- 启动和关闭配额

  启动配额：

  ```
  [root@localhost ~]# quotaon [选项] [分区名]
  选项：
    -a：依据/etc/mtab文件启动所有的配额分区。如果不加-a，后面就一定要指定分区名
    -u：启动用户配额
    -g：启动组配额
    -v：显示启动过程的信息
    
  [root@localhost ~]# quotaon -vug /disk/        # 启动/disk分区的配额
  /dev/sdb1 [/disk]：group quotas turned on
  /dev/sdb1 [/disk]：user quotas turned on
  
  [root@localhost ~]# quotaon -avug        # 这条命令也可以
  ```

  关闭配额：

  ```
  [root@localhost ~]# quotaoff [选项] [分区名]
  选项：
    -a：依据/etc/mtab文件关闭所有的配额分区。如果不加-a，后面就一定要指定分区名
    -u：关闭用户配额
    -g：关闭组配额
    
   [root@localhost ~]# quotaoff -a        # 依据/etc/mtab文件关闭配额分区
  ```



### 4）磁盘配额查询

- quota查询用户或用户组配额

  ```
  [root@localhost ~]# quota [选项] [用户名或组名]
  选项：
    -u 用户名：   查询用户配额
    -g 组名：     查询组配额
    -v：          显示详细信息
    -s：          以习惯单位显示容量大小，如M,G
    
  [root@localhost ~]# quota -uvs user1
  ```

- repquota查询文件系统配额

  ```
  [root@localhost ~]# repquota [选项] [分区名]
  选项：
    -a：    依据/etc/mtab文件查询配额，如果不加-a选项，就一定要加分区名
    -u：    查询用户配额
    -g:     查询组配额
    -v：    显示详细信息
    -s：    以习惯单位显示容量大小
  
  [root@localhost ~]# repquota -augvs
  ```

  

### 5）测试

```
[user1@localhost disk]$ dd if=/dev/zero of=/disk/testfile bs=1M count=60    # 建立testfile文件，指定大小60MB
```



### 6）非交互设定用户磁盘配额

```
[root@localhost ~]# setquota -u 用户名 容量软限制 容量硬限制 个数软限制 个数硬限制 分区名

示例：
[root@localhost ~]# setquota -u user4 10000 20000 5 8 /disk
```



## 2. LVM逻辑卷管理

### 1）简介

LVM是Logical Volume Manager的简称，中文就是逻辑卷管理。

- 物理卷(PV, Physical Volume)：就是真正的物理硬盘或分区。
- 卷组(VG, Volume Group)：将多个物理卷合起来就组成了卷组，组成同一个卷组的物理卷可以是同一个硬盘的不同分区，也可以是不同硬盘上的不同分区，可以把卷组想象为一个逻辑硬盘。
- 逻辑卷(LV, Logical Volume)：卷组是一个逻辑硬盘，硬盘必须分区之后才能使用，这个分区称作逻辑卷，逻辑卷可以格式化和写入数据。可以把逻辑卷想象成为分区。
- 物理扩展(PE, Physical Extend)：PE是用来保存数据的最小单元，数据实际上都是写入PE当中，PE的大小是可以配置的，默认是4MB。



### 2）建立LVM的步骤

- 首先需要把物理硬盘分成分区，当然也可以是整块物理硬盘。
- 然后把物理分区建立成为物理卷(PV)，也可以直接把整块硬盘都建立为物理卷。
- 接下来把物理卷整合成为卷组(VG)。卷组就已经可以动态的调整大小了，可以把物理分区加入卷组，也可以把物理分区从卷组中删除。
- 最后就是把卷组再划分成为逻辑卷(LV)，当然逻辑卷也是可以直接调整大小的。逻辑卷可以想象成为分区，所以也需要格式化和挂载。



### 3）物理卷管理

a）硬盘分区

创建方式就是使用fdisk交互命令，不过需要注意的是分区的系统ID不再是Linux默认的分区ID号(83)了，而要改为LVM的ID号8e。



b）建立物理卷

```
[root@localhost ~]# pvcreate [设备文件名]

示例：
# 把整块硬盘都建立成物理卷
[root@localhost ~]# pvcreate /dev/sdb

# 把分区建立成为物理卷
[root@localhost ~]# pvcreate /dev/sdb5
```



c）查看物理卷

```
[root@localhost ~]# pvscan
[root@localhost ~]# pvdisplay        # 更详细的物理卷信息
```



d）删除物理卷

```
[root@localhost ~]# pvremove /dev/sdb5
```



### 4）卷组管理

a）建立卷组

```
[root@localhost ~]# vgcreate [选项] 卷组名 物理卷名
[选项]：
  -s PE大小    指定PE的大小，单位可以是MB,GB,TB等。如是不写默认PE大小为4MB
```

示例：

```
[root@localhost ~]# vgcreate -s 8MB scvg /dev/sdb5 /dev/sdb6
```



b）查看卷组

查看卷组的命令有两个：

- vgscan

  vgscan主要是查看系统中是否有卷组。

  ```
  [root@localhost ~]# vgscan
  ```

- vgdisplay

  ```
  [root@localhost ~]# vgdisplay
  ```



c）增加卷组容量

```
[root@localhost ~]# vgextend scvg /dev/sdb7
```



d）减小卷组容量

```
# 在卷组中删除/dev/sdb7物理卷
[root@localhost ~]# vgreduce scvg /dev/sdb7
# 删除所有的未使用物理卷
[root@localhost ~]# vgreduce -a
```



e）删除卷组

```
[root@localhost ~]# vgremove scvg
```

卷组删除之后，才能删除物理卷，要注意的是scvg卷组还没有添加任何的逻辑卷，如果拥有了逻辑卷，得先删除逻辑卷再删除卷组。



###  5）逻辑卷管理

a）建立逻辑卷

```
[root@localhost ~]# lvcreate [选项] [-n 逻辑卷名] 卷组名
选项：
  -L 容量：指定逻辑卷大小，单位MB，GB，TB等
  -l 个数：按照PE个数指定逻辑卷大小，这个参数需要换算容量，太麻烦
  -n 逻辑卷名：指定逻辑卷名
```

```
[root@localhost ~]# lvcreate -L 1.5G -n userlv scvg    # 在scvg卷组中建立1.5GB的userlv逻辑卷
```

建立完成逻辑卷之后，还要格式化和挂载之后逻辑卷才能正常使用。不过需要注意的是逻辑卷的设备文件名是/dev/卷组名/逻辑卷名。

```
[root@localhost ~]# mkfs -t ext4 /dev/scvg/userlv
[root@localhost ~]# mkdir /disklvm
[root@localhost ~]# mount /dev/scvg/userlv /disklvm/
[root@localhost ~]# mount      # 查看挂载
```

如果需要开机自动挂载，也要修改/etc/fstab文件。



b）查看逻辑卷

查看命令有两个：

- lvscan

  lvscan只能看到系统中是否拥有逻辑卷。

  ```
  [root@localhost ~]# lvscan
  ```

- lvdisplay

  lvdisplay可以看到逻辑卷的详细信息。

  ```
  [root@localhost ~]# lvdisplay
  ```



c）调整逻辑卷大小

```
[root@localhost ~]# lvresize [选项] 逻辑卷设备文件名
选项：
  -L 容量：安装容量调整大小，单位KB,GB,TB等。使用+代表增加空间，-号代表减少空间。如果直接写容量，代表设定逻辑卷大小为指定大小。
  -l 个数：按照PE个数调整逻辑卷大小
```

示例：

```
[root@localhost ~]# lvresize -L 2.5.G /dev/scvg/userlv
[root@localhost ~]# lvdisplay               # 逻辑卷的大小已经改变了
[root@localhost ~]# df -h /disklvm/         # 大小没有变化
```

lvresize只能改变逻辑卷的大小，如果需要让分区使用这个新逻辑卷，还要使用resize2fs命令来调整分区的大小。不过这里体现了LVM的优势，不需要卸载分区，直接就能调整分区的大小。

```
[root@localhost ~]# resize2fs [选项] [设备文件名] [调整的大小]
选项：
  -f：    强制调整
  设备文件名：指定调整哪个分区的大小
  调整的大小：指定把分区调整到多大，要加M,G等单位。如果不加大小，会使用整个分区
```

```
[root@localhost ~]# resize2fs /dev/scvg/userlv
[root@localhost ~]# df -h /disklvm/       # 已经调整过来了
```



### 4）删除逻辑卷

删除逻辑卷前要先卸载。

```
[root@localhost ~]# lvremove 逻辑卷设备文件名
```



